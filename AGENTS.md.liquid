# Project Guide for AI Agents

This AGENTS.md file provides comprehensive guidance for AI agents working with the {{ project-name | kebab_case }} monorepo codebase.

## Directory Overview

- **bin/{{ project-name | kebab_case }}**  
  The Rust API server binary
- **core**  
  Shared business logic, domain types, and utilities used by the server.
- **core/migrations**  
  SQLx migrations bundled into the binary via `sqlx::migrate!()`.

## Running Unit Tests

Some unit tests in `bin/{{ project-name | kebab_case }}` and `core` require an active local database.  
Avoid using a blanket `cargo test` at the workspace root, as it will run DB-dependent tests that may fail without a running database.

Instead, run only your new tests by crate and test name:

```bash
# From the workspace root, run a single test in the core crate
cargo test -p {{project-name}}-core ${specific_test_name}

# Or go into the crate directly and filter by name
cd core && cargo test ${specific_test_name}
```

## When you need to call tools from the shell, use this rubric

- Find Files: `fd`
- Find Text: `rg` (ripgrep)
- Find Code Structure: `ast-grep`
- Select among matches: pipe to `fzf`
- JSON: `jq`
- YAML/XML: `yq`

## Backend Coding Practices

- **Workspace layout**: Application logic is split between a binary crate under
  `bin/{{ project-name | kebab_case }}` and a reusable library crate in `core`.
  - `core` holds domain models, database stores, and utilities.
  - `bin/server` wires these pieces together to expose GraphQL and REST APIs.
- Keep business logic out of the binary crate whenever possible. New APIs should
  call into functions in `core` instead of performing DB queries directly in the
  handlers.

### Database Queries

- SQLx helpers live under `core/src/sqlx_postgres`. The `users` module includes
  CRUD examples plus a transaction that creates a user and MFA method together.
- Reusable query helpers that work with either a pool or transaction use the
  `PgExecutor` trait in `core/src/sqlx_postgres/users.rs`.
- Connection and migration helpers are centralized in
  `core/src/sqlx_postgres/mod.rs`.

### Migrations

- SQL migration files live under `core/migrations` and are executed using
  `sqlx::migrate!()` through the helper in `core::sqlx_postgres::migrate`.
- Create new migrations by adding a timestamped `.sql` file to that directory.

### Temporal Workflows

We register activities with the helper macros re-exported from `atb_temporal_ext`.
Reference the existing wiring instead of copying new boilerplate:

- `core/src/temporal/mod.rs` centralizes Temporal client setup, plus example
  workflow and activity definitions like the `#[activity]` macro. Use this as
  the reference for creating new workflows and activities.
- `bin/{{ project-name | kebab_case }}/src/worker.rs` shows how workers are
  created and tasks registered.
- `bin/{{ project-name | kebab_case }}/src/http.rs` and
  `bin/{{ project-name | kebab_case }}/src/mono.rs` show workflow engine usage.
